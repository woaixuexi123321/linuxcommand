<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:converters="clr-namespace:LinuxCommandCenter.Converters"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="LinuxCommandCenter.Views.QuickCommandsView">
    
    <UserControl.Resources>
        <converters:BoolToBrushConverter x:Key="BoolToBrushConverter"/>
        <converters:BoolToStringConverter x:Key="BoolToStringConverter"/>
        <converters:IsNotNullConverter x:Key="IsNotNullConverter"/>
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <Border Grid.Row="0" Classes="card" Margin="0,0,0,16">
            <StackPanel>
                <TextBlock Text="Quick Commands" Classes="title" Margin="0,0,0,8"/>
                <TextBlock Text="Execute common Linux commands with one click. Search and filter commands by category or name." 
                          Classes="subtitle" TextWrapping="Wrap"/>
            </StackPanel>
        </Border>
        
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="2*"/>
            </Grid.ColumnDefinitions>
            
            <!-- Left Panel - Presets -->
            <Border Grid.Column="0" Margin="0,0,8,0" Classes="card">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Search Box -->
                    <StackPanel Grid.Row="0" Spacing="12" Margin="0,0,0,16">
                        <TextBox Text="{Binding SearchTerm, Mode=TwoWay}" Watermark="Search commands...">
                            <TextBox.Styles>
                                <Style Selector="TextBox">
                                    <Setter Property="BorderThickness" Value="0"/>
                                    <Setter Property="Background" Value="#2D3748"/>
                                    <Setter Property="CornerRadius" Value="20"/>
                                    <Setter Property="Padding" Value="16,12"/>
                                </Style>
                            </TextBox.Styles>
                        </TextBox>
                        
                        <WrapPanel>
                            <Border CornerRadius="12" Background="#334155" Padding="8,4" Margin="0,0,8,0">
                                <TextBlock Text="{Binding FilteredPresets.Count, StringFormat='Commands: {0}'}" 
                                          Foreground="#94A3B8" FontSize="12"/>
                            </Border>
                            <Border CornerRadius="12" Background="#334155" Padding="8,4">
                                <TextBlock Text="{Binding CommandHistory.Count, StringFormat='History: {0}'}" 
                                          Foreground="#94A3B8" FontSize="12"/>
                            </Border>
                        </WrapPanel>
                    </StackPanel>
                    
                    <!-- Command List -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <!-- 关键：ItemsSource 绑定到 FilteredPresets -->
                        <ItemsControl ItemsSource="{Binding FilteredPresets}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Margin="0,0,0,8" Background="#2D3748" CornerRadius="8" Padding="12">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <!-- 命令信息 -->
                                            <StackPanel Grid.Column="0" Spacing="4">
                                                <StackPanel Orientation="Horizontal" Spacing="6">
                                                    <TextBlock Text="{Binding Name}" FontWeight="SemiBold" Foreground="#F8FAFC"/>
                                                    <Border CornerRadius="4" Padding="2,1" Background="#3B82F6" 
                                                            IsVisible="{Binding IsFavorite}">
                                                        <TextBlock Text="★" FontSize="9" Foreground="White"/>
                                                    </Border>
                                                    <Border CornerRadius="4" Padding="2,4" Background="#EF4444" 
                                                            IsVisible="{Binding RequiresSudo}">
                                                        <TextBlock Text="SUDO" FontSize="9" Foreground="White" FontWeight="Bold"/>
                                                    </Border>
                                                </StackPanel>
                                                <TextBlock Text="{Binding Description}" Foreground="#94A3B8" 
                                                          FontSize="12" TextWrapping="Wrap"/>
                                                <Border CornerRadius="4" Background="#1E293B" Padding="4,2" 
                                                        HorizontalAlignment="Left">
                                                    <TextBlock Text="{Binding Category}" Foreground="#60A5FA" 
                                                              FontSize="10" FontWeight="SemiBold"/>
                                                </Border>
                                            </StackPanel>
                                            
                                            <!-- Run 按钮 - 关键：正确绑定命令和参数 -->
                                            <Button Grid.Column="1" 
                                                    Command="{Binding DataContext.ExecutePresetCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding}" 
                                                    VerticalAlignment="Center" 
                                                    Padding="8,6" 
                                                    Classes="primary">
                                                <TextBlock Text="Run"/>
                                            </Button>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>
            
            <!-- Right Panel - Execution -->
            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- Custom Command Input -->
                <Border Grid.Row="0" Classes="card" Margin="0,0,0,16">
                    <StackPanel Spacing="16">
                        <TextBlock Text="Custom Command" FontWeight="SemiBold" Foreground="#F8FAFC"/>
                        
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBox Grid.Column="0" Text="{Binding CustomCommand, Mode=TwoWay}" 
                                    Watermark="Enter custom Linux command..." Margin="0,0,12,0"/>
                            
                            <CheckBox Grid.Column="1" Content="Use sudo" IsChecked="{Binding UseSudo}" 
                                     VerticalAlignment="Center" Foreground="#94A3B8"/>
                        </Grid>
                        
                        <StackPanel Orientation="Horizontal" Spacing="12" HorizontalAlignment="Right">
                            <Button Command="{Binding ClearHistoryCommand}" Classes="danger">
                                <StackPanel Orientation="Horizontal" Spacing="6">
                                    <PathIcon Data="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" 
                                            Width="16" Height="16"/>
                                    <TextBlock Text="Clear History"/>
                                </StackPanel>
                            </Button>
                            
                            <Button Command="{Binding ExecuteCustomCommandCommand}" Classes="primary" Padding="20,12">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <PathIcon Data="M8 5v14l11-7z" Width="20" Height="20"/>
                                    <TextBlock Text="Execute Command" FontWeight="SemiBold"/>
                                </StackPanel>
                            </Button>
                        </StackPanel>
                    </StackPanel>
                </Border>
                
                <!-- Command Output -->
                <Border Grid.Row="1" Classes="card" Margin="0,0,0,16">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="12" Margin="0,0,0,12">
                            <TextBlock Text="Output" FontWeight="SemiBold" Foreground="#F8FAFC"/>
                            
                            <Border CornerRadius="12" 
                                    Background="{Binding LastResult.IsSuccess, Converter={StaticResource BoolToBrushConverter}, ConverterParameter='#10B981:#EF4444'}" 
                                    Padding="6,2" 
                                    IsVisible="{Binding LastResult, Converter={StaticResource IsNotNullConverter}}">
                                <TextBlock Text="{Binding LastResult.IsSuccess, Converter={StaticResource BoolToStringConverter}, ConverterParameter='Success:Failed'}" 
                                          Foreground="White" FontSize="11" FontWeight="SemiBold"/>
                            </Border>
                            
                            <TextBlock Text="{Binding LastResult.ExecutionTime, StringFormat='Time: {0:mm\\:ss\\.fff}'}" 
                                      Foreground="#94A3B8" FontSize="12" 
                                      IsVisible="{Binding LastResult, Converter={StaticResource IsNotNullConverter}}"/>
                        </StackPanel>
                        
                        <ScrollViewer Grid.Row="1">
                            <TextBox Text="{Binding LastResult.Output}" IsReadOnly="True" AcceptsReturn="True" 
                                    TextWrapping="Wrap" FontFamily="Consolas, Monaco, 'Courier New', monospace" 
                                    FontSize="12" Background="Transparent" BorderThickness="0" Padding="0"/>
                        </ScrollViewer>
                    </Grid>
                </Border>
                
                <!-- Command History -->
                <Border Grid.Row="2" Classes="card">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8" Margin="0,0,0,12">
                            <PathIcon Data="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z" 
                                    Width="16" Height="16"/>
                            <TextBlock Text="Recent Commands" FontWeight="SemiBold" Foreground="#F8FAFC"/>
                        </StackPanel>
                        
                        <ScrollViewer Grid.Row="1" MaxHeight="200" VerticalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding CommandHistory}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Margin="0,0,0,4" Background="#2D3748" CornerRadius="6" Padding="8">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <StackPanel Grid.Column="0" Spacing="2">
                                                    <TextBlock Text="{Binding Command}" FontFamily="Consolas" FontSize="11" 
                                                              Foreground="#E2E8F0" TextTrimming="CharacterEllipsis"/>
                                                    <TextBlock Text="{Binding Timestamp, StringFormat='Executed: {0:HH:mm:ss}'}" 
                                                              Foreground="#94A3B8" FontSize="10"/>
                                                </StackPanel>
                                                
                                                <Border Grid.Column="1" CornerRadius="4" Padding="2,1" 
                                                        Background="{Binding IsSuccess, Converter={StaticResource BoolToBrushConverter}, ConverterParameter='#10B981:#EF4444'}">
                                                    <TextBlock Text="{Binding ExitCode}" Foreground="White" FontSize="10" FontWeight="Bold"/>
                                                </Border>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>
                </Border>
            </Grid>
        </Grid>
    </Grid>
</UserControl>